# pageinsepct使用总结

hash索引：0号代表元页、1号、2号代表桶页，3号代表位图页

返回hash索引页面类型（元页、溢出页、位图页），
参数：索引名+页号

## 1、查看页面类型（元页、桶页、位图页）

postgres=# select hash_page_type(get_raw_page('idx',0));

 hash_page_type

 metapage
(1 行记录)


postgres=# select hash_page_type(get_raw_page('idx',1));

 hash_page_type

 bucket
(1 行记录)


postgres=# select hash_page_type(get_raw_page('idx',2));

 hash_page_type

 bucket
(1 行记录)


postgres=# select hash_page_type(get_raw_page('idx',3));

 hash_page_type

 bitmap
(1 行记录)



## 2、hash索引元页信息查看：

参数：索引名 + 页号

postgres=# select * from hash_metapage_info(get_raw_page('idx',0));
-[ RECORD 1 ]--------------------------------------------------------------------------------------------------------------------------------------------magic     | 105121344
version   | 4
ntuples   | 624676
ffactor   | 307
bsize     | 8152
bmsize    | 4096
bmshift   | 15
maxbucket | 2034
highmask  | 2047
lowmask   | 1023
ovflpoint | 17
firstfree | 355
nmaps     | 1
procid    | 455
spares    | {0,1,2,3,4,8,17,39,110,310,366,372,615,646,919,949,1229,1531,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0}
mapp      | {3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0}

## 3、 查看某一桶页活动行、死亡的行数，计算膨胀率

postgres=# select * from hash_page_stats(get_raw_page('idx',1));
-[ RECORD 1 ]---+------
live_items      | 407
dead_items      | 0
page_size       | 8192
free_size       | 8
hasho_prevblkno | 1024
hasho_nextblkno | 37
hasho_bucket    | 0
hasho_flag      | 2
hasho_page_id   | 65408

## 4、hash_page_items查看HASH 索引页的桶或溢出页的数据

postgres=# SELECT * FROM hash_page_items(get_raw_page('idx', 1)) LIMIT 5;
-[ RECORD 1 ]---------
itemoffset | 1
ctid       | (6,1)
data       | 543207424
-[ RECORD 2 ]---------
itemoffset | 2
ctid       | (3279,1)
data       | 667832320
-[ RECORD 3 ]---------
itemoffset | 3
ctid       | (3286,24)
data       | 667832320
-[ RECORD 4 ]---------
itemoffset | 4
ctid       | (3294,13)
data       | 667832320
-[ RECORD 5 ]---------
itemoffset | 5
ctid       | (3301,36)
data       | 667832320



## 主键索引测试

create table hot_test (id int primary key,info text);
insert into hot_test values (1,'digoal');

查看堆块内

postgres=# select * from heap_page_items(get_raw_page('hot_test_pkey',0));
 lp | lp_off | lp_flags | lp_len | t_xmin | t_xmax | t_field3 | t_ctid | t_infomask2 | t_infomask | t_hoff | t_bits | t_oid | t_data
----+--------+----------+--------+--------+--------+----------+--------+-------------+------------+--------+--------+-------+--------
  1 |  12642 |        2 |      2 |        |        |          |        |             |            |        |        |       |
  2 |      2 |        0 |      0 |        |        |          |        |             |            |        |        |       |
  3 |      1 |        0 |      0 |        |        |          |        |             |            |        |        |       |
  4 |      0 |        0 |      0 |        |        |          |        |             |            |        |        |       |
  5 |      1 |        0 |      0 |        |        |          |        |             |            |        |        |       |
  6 |      0 |        0 |      0 |        |        |          |        |             |            |        |        |       |
(6 rows)

查看块头部信息：

postgres=#     select * from page_header(get_raw_page('hot_test_pkey',0));
    lsn    | checksum | flags | lower | upper | special | pagesize | version | prune_xid
-----------+----------+-------+-------+-------+---------+----------+---------+-----------
 2/1FA01B0 |        0 |     0 |    48 |  8176 |    8176 |     8192 |       4 |         0
(1 row)

查看索引项（索引元组内部结构）

postgres=# SELECT * FROM bt_page_items('hot_test_pkey', 1);
 itemoffset | ctid  | itemlen | nulls | vars |          data
------------+-------+---------+-------+------+-------------------------
          1 | (0,1) |      16 | f     | f    | 01 00 00 00 00 00 00 00
          2 | (0,2) |      16 | f     | f    | 02 00 00 00 00 00 00 00
          3 | (0,3) |      16 | f     | f    | 03 00 00 00 00 00 00 00
(3 rows)

itemoffset  索引行在块内偏移量

ctid  元组的物理位置

itemlen 项长度

nulls 是否为空

vars 可变长

data 数据



查看索引页整体信息

postgres=# SELECT * FROM bt_page_stats('hot_test_pkey', 1);
 blkno | type | live_items | dead_items | avg_item_size | page_size | free_size | btpo_prev | btpo_next | btpo | btpo_flags
-------+------+------------+------------+---------------+-----------+-----------+-----------+-----------+------+------------
     1 | l    |          1 |          0 |            16 |      8192 |      8128 |         0 |         0 |    0 |          3
(1 row)







