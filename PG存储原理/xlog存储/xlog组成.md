# xlog分析



### 根据LSN确定对应xlog的segment文件

利用下面函数进行确定：

pg_xlogfile_name_offset(location pg_lsn) 把事务日志的位置转换为文件名和文件内部十进制字节的偏移量

```
postgres=# select pg_xlogfile_name_offset('0/2B0483F8');
      pg_xlogfile_name_offset
-----------------------------------
 (00000006000000000000002B,295928)
(1 row)
```

pg_xlogfile_name(location pg_lsn) 通过事务日志转换为文件名

```
postgres=# select pg_xlogfile_name('0/2B0483F8');
     pg_xlogfile_name
--------------------------
 00000006000000000000002B
(1 row)
```



### xlog组成

命名 00000006000000000000002B

00000006 00000000 0000002B

第一部分：timeline ID

第二部分： 逻辑文件ID

第三部分： 物理文件ID

每个文件16MB。

和LSN对应关系：

0/2B0483F8

斜杠前的0代表逻辑文件ID

2B0483F8代表物理文件ID（具体计算方法，右移6位，为2B）。

## pg_xlogdump 工具简介

[postgres@node3 pg_xlog]$ pg_xlogdump --help
pg_xlogdump decodes and displays PostgreSQL transaction logs for debugging.

Usage:
  pg_xlogdump [OPTION]... [STARTSEG [ENDSEG]]

Options:
  -b, --bkp-details      output detailed information about backup blocks
  -e, --end=RECPTR       stop reading at log position RECPTR
  -f, --follow           keep retrying after reaching end of WAL
  -n, --limit=N          number of records to display
  -p, --path=PATH        directory in which to find log segment files or a
                         directory with a ./pg_xlog that contains such files
                         (default: current directory, ./pg_xlog, PGDATA/pg_xlog)
  -r, --rmgr=RMGR        only show records generated by resource manager RMGR
                         use --rmgr=list to list valid resource manager names
  -s, --start=RECPTR     start reading at log position RECPTR
  -t, --timeline=TLI     timeline from which to read log records
                         (default: 1 or the value used in STARTSEG)
  -V, --version          output version information, then exit
  -x, --xid=XID          only show records with TransactionId XID
  -z, --stats[=record]   show statistics instead of records
                         (optionally, show per-record statistics)
  -?, --help             show this help, then exit



## 分析xlog方法：

**例一：查看00000006000000000000002B最早的4个XLOG Record**

[postgres@node3 pg_xlog]$  pg_xlogdump -n 4 -p ./ -s 0/2B0483F8 -t 6
rmgr: Standby     len (rec/tot):     50/    50, tx:          0, lsn: 0/2B0483F8, prev 0/2B0483C0, desc: RUNNING_XACTS nextXid 1840 latestCompletedXid 1839 oldestRunningXid 1840
rmgr: XLOG        len (rec/tot):    106/   106, tx:          0, lsn: 0/2B048430, prev 0/2B0483F8, desc: CHECKPOINT_ONLINE redo 0/2B0483F8; tli 6; prev tli 6; fpw true; xid 0:1840; oid 25271; multi 1; offset 0; oldest xid 1753 in DB 1; oldest multi 1 in DB 1; oldest/newest commit timestamp xid: 0/0; oldest running xid 1840; online
rmgr: Standby     len (rec/tot):     50/    50, tx:          0, lsn: 0/2B0484A0, prev 0/2B048430, desc: RUNNING_XACTS nextXid 1840 latestCompletedXid 1839 oldestRunningXid 1840
rmgr: Standby     len (rec/tot):     50/    50, tx:          0, lsn: 0/2B0484D8, prev 0/2B0484A0, desc: RUNNING_XACTS nextXid 1840 latestCompletedXid 1839 oldestRunningXid 1840



**例二：查看Redo point后的XLOG Record**

[postgres@node3 pg_xlog]$ **pg_controldata**
pg_control version number:            960
Catalog version number:               201608131
Database system identifier:           6715974768828976892
Database cluster state:               in production
pg_control last modified:             Sun 15 Sep 2019 06:15:03 AM EDT
Latest checkpoint location:           0/2B048A50
Prior checkpoint location:            0/2B048970
Latest checkpoint's REDO location:    **0/2B048A18**
Latest checkpoint's REDO WAL file:    00000006000000000000002B
Latest checkpoint's TimeLineID:       6
Latest checkpoint's PrevTimeLineID:   6

...............................

命令：**pg_xlogdump -n 4 -p ./ -s 0/2B048A18 -t 6**

[postgres@node3 pg_xlog]$  pg_xlogdump -n 4 -p ./ -s 0/2B048A18 -t 6
rmgr: Storage     len (rec/tot):     42/    42, tx:          0, lsn: 1/E4027F90, prev 1/E40262D8, desc: CREATE base/13325/33480
rmgr: Heap        len (rec/tot):    203/   203, tx:       1920, lsn: 1/E4027FC0, prev 1/E4027F90, desc: INSERT off 41
        blkref #0: rel 1663/13325/25301 fork main blk 9
rmgr: Btree       len (rec/tot):     53/  1633, tx:       1920, lsn: 1/E40280A8, prev 1/E4027FC0, desc: INSERT_LEAF off 77
        blkref #0: rel 1663/13325/25304 fork main blk 2 (FPW); hole: offset: 332, length: 6612

rmgr: Btree       len (rec/tot):     72/    72, tx:       1920, lsn: 1/E4028710, prev 1/E40280A8, desc: INSERT_LEAF off 179
        blkref #0: rel 1663/13325/25305 fork main blk 2
rmgr: Standby     len (rec/tot):     54/    54, tx:          0, lsn: 1/E4028758, prev 1/E4028710, desc: RUNNING_XACTS nextXid 1921 la
testCompletedXid 1919 oldestRunningXid 1920; 1 xacts: 1920
rmgr: Heap        len (rec/tot):     54/  8226, tx:       1920, lsn: 1/E4028790, prev 1/E4028758, desc: INSERT off 108
        blkref #0: rel 1663/13325/2608 fork main blk 44 (FPW); hole: offset: 612, length: 20

字段解释：

#### rmgr：指定资源管理器类型，有Btree、Heap、heap2、Storage等，取自 src/include/access/rmgrlist.h  

#### len指定xlogRecord资源管理器长度和该记录的长度，取自XLogRecord.xl_len和XLogRecord.xl_tot_len  。

#### tx：指定事务id

#### lsn：xlogRecord在xlog文件的偏移量，单调递增

#### desc:操作描述

#### rel组成介绍:

1663/13325/25304

1663--表空间oid

13325--数据库oid

25304--表的数据文件id

查看某个对象的rel：

postgres=# \d
         List of relations
 Schema |  Name  | Type  |  Owner
--------+--------+-------+----------
 public | caocao | table | postgres
 public | test   | table | postgres
(2 rows)

#### postgres=#          select pg_relation_filepath('test');

 pg_relation_filepath

 base/13325/33480
(1 row)



#### 参考链接

http://www.postgres.cn/v2/news/viewone/1/96

